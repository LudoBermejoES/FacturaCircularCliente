<% content_for :title, "Edit Company Establishment" %>

<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center">
      <%= link_to company_establishments_path,
          class: "mr-3 inline-flex items-center text-sm text-gray-500 hover:text-gray-700" do %>
        <svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Establishments
      <% end %>
    </div>
    <h1 class="text-3xl font-bold leading-tight text-gray-900">Edit Company Establishment</h1>
    <p class="mt-1 text-sm text-gray-500">
      Update establishment details and tax configuration
    </p>
  </div>

  <!-- Form Card -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-6 py-6">
      <%= form_with url: company_establishment_path(@establishment[:id]), method: :patch,
          local: true, class: "space-y-6" do |form| %>

        <!-- Basic Information Section -->
        <div>
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Basic Information</h3>

          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <!-- Name -->
            <div>
              <%= form.label "establishment[name]", "Name", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field "establishment[name]",
                  value: @establishment[:name],
                  class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                  placeholder: "e.g., Main Office, Barcelona Warehouse" %>
              <% if @establishment[:errors] && @establishment[:errors][:name] %>
                <p class="mt-1 text-sm text-red-600"><%= @establishment[:errors][:name].first %></p>
              <% end %>
            </div>

            <!-- Currency -->
            <div>
              <%= form.label "establishment[currency_code]", "Currency", class: "block text-sm font-medium text-gray-700" %>
              <%= form.select "establishment[currency_code]",
                  options_for_select([
                    ['Euro (EUR)', 'EUR'],
                    ['US Dollar (USD)', 'USD'],
                    ['British Pound (GBP)', 'GBP'],
                    ['Mexican Peso (MXN)', 'MXN'],
                    ['Polish ZÅ‚oty (PLN)', 'PLN']
                  ], @establishment[:currency_code]),
                  { prompt: "Select currency" },
                  { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" } %>
              <% if @establishment[:errors] && @establishment[:errors][:currency_code] %>
                <p class="mt-1 text-sm text-red-600"><%= @establishment[:errors][:currency_code].first %></p>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Address Section -->
        <div class="border-t border-gray-200 pt-6">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Address</h3>

          <div class="space-y-4">
            <!-- Address Line 1 -->
            <div>
              <%= form.label "establishment[address_line_1]", "Address Line 1", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field "establishment[address_line_1]",
                  value: @establishment[:address_line_1],
                  class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                  placeholder: "Street address" %>
              <% if @establishment[:errors] && @establishment[:errors][:address_line_1] %>
                <p class="mt-1 text-sm text-red-600"><%= @establishment[:errors][:address_line_1].first %></p>
              <% end %>
            </div>

            <!-- Address Line 2 -->
            <div>
              <%= form.label "establishment[address_line_2]", "Address Line 2 (Optional)", class: "block text-sm font-medium text-gray-700" %>
              <%= form.text_field "establishment[address_line_2]",
                  value: @establishment[:address_line_2],
                  class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                  placeholder: "Apartment, suite, etc." %>
            </div>

            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
              <!-- City -->
              <div>
                <%= form.label "establishment[city]", "City", class: "block text-sm font-medium text-gray-700" %>
                <%= form.text_field "establishment[city]",
                    value: @establishment[:city],
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
                <% if @establishment[:errors] && @establishment[:errors][:city] %>
                  <p class="mt-1 text-sm text-red-600"><%= @establishment[:errors][:city].first %></p>
                <% end %>
              </div>

              <!-- State/Province -->
              <div>
                <%= form.label "establishment[state_province]", "State/Province", class: "block text-sm font-medium text-gray-700" %>
                <%= form.text_field "establishment[state_province]",
                    value: @establishment[:state_province],
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
              </div>

              <!-- Postal Code -->
              <div>
                <%= form.label "establishment[postal_code]", "Postal Code", class: "block text-sm font-medium text-gray-700" %>
                <%= form.text_field "establishment[postal_code]",
                    value: @establishment[:postal_code],
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
                <% if @establishment[:errors] && @establishment[:errors][:postal_code] %>
                  <p class="mt-1 text-sm text-red-600"><%= @establishment[:errors][:postal_code].first %></p>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Tax Configuration Section -->
        <div class="border-t border-gray-200 pt-6">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Tax Configuration</h3>

          <div class="space-y-4">
            <!-- Tax Jurisdiction -->
            <div>
              <%= form.label "establishment[tax_jurisdiction_id]", "Tax Jurisdiction", class: "block text-sm font-medium text-gray-700" %>
              <% if @jurisdictions.present? %>
                <%= form.select "establishment[tax_jurisdiction_id]",
                    options_for_select(@jurisdictions.map { |j| [j[:name], j[:id]] }, @establishment[:tax_jurisdiction_id]),
                    { prompt: "Select tax jurisdiction" },
                    { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" } %>
              <% else %>
                <div class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 px-3 py-2 text-sm text-gray-500">
                  No tax jurisdictions available. Please contact system administrator.
                </div>
              <% end %>
              <p class="mt-1 text-sm text-gray-500">
                The tax jurisdiction determines applicable tax rates and requirements for this location
              </p>
              <% if @establishment[:errors] && @establishment[:errors][:tax_jurisdiction_id] %>
                <p class="mt-1 text-sm text-red-600"><%= @establishment[:errors][:tax_jurisdiction_id].first %></p>
              <% end %>
            </div>

            <!-- Default Location -->
            <div class="flex items-center">
              <%= form.check_box "establishment[is_default]",
                  checked: @establishment[:is_default],
                  class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
              <%= form.label "establishment[is_default]", "Set as default establishment",
                  class: "ml-2 block text-sm text-gray-700" %>
              <div class="ml-3">
                <div class="relative" data-controller="tooltip" data-tooltip-content="Only one establishment can be the default. This will be used for invoices when no specific establishment is selected.">
                  <svg class="h-4 w-4 text-gray-400 cursor-help" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <% if @establishment[:is_default] %>
                <span class="ml-3 inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">
                  Currently Default
                </span>
              <% end %>
            </div>

            <!-- Warning for Default Change -->
            <% if @establishment[:is_default] %>
              <div class="rounded-md bg-yellow-50 p-4">
                <div class="flex">
                  <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">
                      Default Establishment
                    </h3>
                    <div class="mt-2 text-sm text-yellow-700">
                      <p>This is currently your default establishment. Unchecking this will remove the default status, and you'll need to set another establishment as default.</p>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Current Status Information -->
        <div class="border-t border-gray-200 pt-6">
          <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Current Status</h3>
          <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            <div>
              <dt class="text-sm font-medium text-gray-500">Created</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <% if @establishment[:created_at] %>
                  <%= Time.parse(@establishment[:created_at]).strftime("%B %d, %Y at %I:%M %p") %>
                <% else %>
                  Not available
                <% end %>
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Last Updated</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <% if @establishment[:updated_at] %>
                  <%= Time.parse(@establishment[:updated_at]).strftime("%B %d, %Y at %I:%M %p") %>
                <% else %>
                  Not available
                <% end %>
              </dd>
            </div>
          </dl>
        </div>

        <!-- Form Actions -->
        <div class="border-t border-gray-200 pt-6 flex justify-between">
          <div>
            <% unless @establishment[:is_default] %>
              <%= link_to company_establishment_path(@establishment[:id]),
                  method: :delete,
                  data: {
                    confirm: "Are you sure you want to delete this establishment? This action cannot be undone.",
                    turbo_method: :delete
                  },
                  class: "inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" do %>
                <svg class="mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete Establishment
              <% end %>
            <% end %>
          </div>
          <div class="flex space-x-3">
            <%= link_to company_establishments_path,
                class: "bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" do %>
              Cancel
            <% end %>
            <%= form.submit "Update Establishment",
                class: "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600" %>
          </div>
        </div>

      <% end %>
    </div>
  </div>
</div>

<!-- Simple tooltip implementation -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggers = document.querySelectorAll('[data-controller="tooltip"]');

    tooltipTriggers.forEach(trigger => {
      const content = trigger.dataset.tooltipContent;
      let tooltip = null;

      trigger.addEventListener('mouseenter', function() {
        tooltip = document.createElement('div');
        tooltip.className = 'absolute z-50 px-2 py-1 text-xs text-white bg-gray-900 rounded shadow-lg -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap';
        tooltip.textContent = content;
        trigger.appendChild(tooltip);
      });

      trigger.addEventListener('mouseleave', function() {
        if (tooltip) {
          tooltip.remove();
          tooltip = null;
        }
      });
    });
  });
</script>