<%= form_with model: @workflow_state,
              url: form_url,
              local: true,
              method: (defined?(form_method) ? form_method : :post),
              class: "space-y-6" do |form| %>

  <% if flash[:error] %>
    <div class="rounded-md bg-red-50 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            There were problems with your submission
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <%= flash[:error] %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Basic Information -->
    <div class="space-y-4">
      <div>
        <%= form.label :name, "Display Name", class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_field :name,
                            value: @workflow_state.name,
                            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
                            placeholder: "e.g., Pending Review" %>
        <p class="mt-1 text-sm text-gray-500">Human-readable name shown in the interface</p>
      </div>

      <div>
        <%= form.label :code, "System Code", class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_field :code,
                            value: @workflow_state.code,
                            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono",
                            placeholder: "e.g., pending_review" %>
        <p class="mt-1 text-sm text-gray-500">System code (lowercase, underscores only)</p>
      </div>

      <div>
        <%= form.label :category, class: "block text-sm font-medium text-gray-700" %>
        <%= form.select :category,
                        options_for_select([
                          ['Draft', 'draft'],
                          ['Review', 'review'],
                          ['Approved', 'approved'],
                          ['Rejected', 'rejected'],
                          ['Cancelled', 'cancelled'],
                          ['Custom', '']
                        ], @workflow_state.category),
                        { include_blank: 'Select category' },
                        { class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" } %>
        <p class="mt-1 text-sm text-gray-500">Logical grouping for similar states</p>
      </div>
    </div>

    <!-- Visual and Positioning -->
    <div class="space-y-4">
      <div>
        <%= form.label :color, class: "block text-sm font-medium text-gray-700" %>
        <div class="mt-1 flex items-center space-x-3">
          <%= form.color_field :color,
                               value: @workflow_state.color,
                               class: "block w-20 h-10 rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
          <%= form.text_field :color,
                              value: @workflow_state.color,
                              class: "block flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono",
                              placeholder: "#6B7280" %>
        </div>
        <p class="mt-1 text-sm text-gray-500">Color used for badges and indicators</p>
      </div>

      <div>
        <%= form.label :position, class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :position,
                              value: @workflow_state.position,
                              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
                              min: 1,
                              step: 1 %>
        <p class="mt-1 text-sm text-gray-500">Display order (lower numbers appear first)</p>
      </div>
    </div>
  </div>

  <!-- State Type Options -->
  <div class="space-y-4">
    <h3 class="text-lg font-medium text-gray-900">State Type</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="flex items-start">
        <div class="flex items-center h-5">
          <%= form.check_box :is_initial,
                             {
                               checked: @workflow_state.is_initial,
                               class: "focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                             },
                             "1", "0" %>
        </div>
        <div class="ml-3 text-sm">
          <%= form.label :is_initial, "Initial State", class: "font-medium text-gray-700" %>
          <p class="text-gray-500">Invoices start in this state when workflow begins</p>
        </div>
      </div>

      <div class="flex items-start">
        <div class="flex items-center h-5">
          <%= form.check_box :is_final,
                             {
                               checked: @workflow_state.is_final,
                               class: "focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded"
                             },
                             "1", "0" %>
        </div>
        <div class="ml-3 text-sm">
          <%= form.label :is_final, "Final State", class: "font-medium text-gray-700" %>
          <p class="text-gray-500">Workflow ends when invoices reach this state</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
    <%= link_to workflow_definition_workflow_states_path(@workflow_definition[:id] || @workflow_definition['id']),
                class: "btn-secondary" do %>
      Cancel
    <% end %>
    <%= form.submit submit_label,
                    class: "btn-primary" %>
  </div>
<% end %>

<script>
  // Sync color picker with text input
  document.addEventListener('DOMContentLoaded', function() {
    const colorPicker = document.querySelector('input[type="color"]');
    const colorText = document.querySelector('input[type="text"][placeholder="#6B7280"]');

    if (colorPicker && colorText) {
      colorPicker.addEventListener('change', function() {
        colorText.value = this.value.toUpperCase();
      });

      colorText.addEventListener('change', function() {
        if (this.value.match(/^#[0-9A-F]{6}$/i)) {
          colorPicker.value = this.value;
        }
      });
    }

    // Auto-generate system code from display name
    const displayName = document.querySelector('#workflow_state_name');
    const systemCode = document.querySelector('#workflow_state_code');

    if (displayName && systemCode) {
      displayName.addEventListener('input', function() {
        if (!systemCode.value || systemCode.dataset.autoGenerated !== 'false') {
          const generated = this.value
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '_')
            .replace(/^_+|_+$/g, '');
          systemCode.value = generated;
          systemCode.dataset.autoGenerated = 'true';
        }
      });

      systemCode.addEventListener('input', function() {
        this.dataset.autoGenerated = 'false';
      });
    }
  });
</script>