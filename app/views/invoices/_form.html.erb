<%= form_with url: invoice.is_a?(Hash) && invoice[:id].present? ? invoice_path(invoice[:id]) : invoices_path, 
              method: invoice.is_a?(Hash) && invoice[:id].present? ? :patch : :post,
              scope: :invoice,
              local: true, 
              data: { controller: "invoice-form" },
              class: "space-y-6" do |form| %>
  
  <% if @errors.present? %>
    <div class="rounded-md bg-red-50 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            There were errors with your submission
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% @errors.each do |field, messages| %>
                <% Array(messages).each do |message| %>
                  <li><%= field.to_s.humanize %> <%= message %></li>
                <% end %>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Invoice Header -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Invoice Information</h3>
      
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
        <div>
          <%= form.label :invoice_series_id, "Invoice Series", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :invoice_series_id,
              options_for_select(
                (@invoice_series || []).map { |series| ["#{series[:series_code]} - #{series[:series_name]}", series[:id].to_s] },
                invoice[:invoice_series_id]&.to_s
              ),
              { include_blank: 'Select invoice series' },
              class: field_class("invoice_series_id", "mt-1 block w-full rounded-md shadow-sm focus:ring-indigo-500 sm:text-sm", @errors),
              data: {
                action: "change->invoice-form#onSeriesChange",
                "invoice-form-target": "seriesSelect"
              },
              required: true %>
          <% if @errors && @errors["invoice_series_id"] %>
            <% @errors["invoice_series_id"].each do |error| %>
              <p class="mt-1 text-sm text-red-600"><%= error %></p>
            <% end %>
          <% end %>
        </div>
        
        <div>
          <%= form.label :invoice_number, "Invoice Number", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_field :invoice_number, value: invoice[:invoice_number],
              class: field_class("invoice_number", "mt-1 block w-full rounded-md bg-gray-50 shadow-sm sm:text-sm", @errors),
              placeholder: "Will be auto-generated",
              readonly: true,
              data: { "invoice-form-target": "invoiceNumber" } %>
          <p class="mt-1 text-xs text-gray-500">Number will be automatically assigned when you select a series</p>
          <% if @errors && @errors["invoice_number"] %>
            <% @errors["invoice_number"].each do |error| %>
              <p class="mt-1 text-sm text-red-600"><%= error %></p>
            <% end %>
          <% end %>
        </div>
        
        <div>
          <%= form.label :invoice_type, class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :invoice_type,
              options_for_select([
                ['Invoice', 'invoice'],
                ['Credit Note', 'credit_note'],
                ['Debit Note', 'debit_note'],
                ['Proforma', 'proforma']
              ], invoice[:invoice_type]),
              {},
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              data: {
                action: "change->invoice-form#onInvoiceTypeChange",
                "invoice-form-target": "invoiceTypeSelect"
              } %>
        </div>
        
        <div>
          <%= form.label :status, class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :status,
              options_for_select([
                ['Draft', 'draft'],
                ['Pending', 'pending'],
                ['Sent', 'sent'],
                ['Paid', 'paid'],
                ['Cancelled', 'cancelled']
              ], invoice[:status]),
              {},
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>

        <div>
          <%= form.label :workflow_definition_id, "Workflow", class: "block text-sm font-medium text-gray-700" %>
          <%
            # Find Simple Invoice Workflow and set as default
            simple_workflow = (@workflows || []).find { |w|
              (w[:name] || w['name']) == 'Simple Invoice Workflow' ||
              (w[:code] || w['code']) == 'simple_invoice_workflow'
            }
            default_workflow_id = simple_workflow ? (simple_workflow[:id] || simple_workflow['id']).to_s : nil
            selected_workflow = (invoice[:workflow_definition_id] || invoice['workflow_definition_id']).to_s.presence || default_workflow_id
          %>
          <%= form.select :workflow_definition_id,
              options_for_select(
                (@workflows || []).map { |workflow| [workflow[:name] || workflow['name'], (workflow[:id] || workflow['id']).to_s] },
                selected_workflow
              ),
              { include_blank: 'Select workflow' },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              required: true %>
          <p class="mt-1 text-xs text-gray-500">Choose the approval workflow for this invoice</p>
        </div>
        
        <div>
          <%= form.label :seller_party_id, "From (Seller)", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :seller_party_id,
              options_for_select(
                (@seller_companies || @companies || []).map { |c| [c[:name], c[:id]] },
                invoice[:seller_party_id] || current_company_id
              ),
              { include_blank: 'Select seller company' },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              required: true %>
          <p class="mt-1 text-xs text-gray-500">Select your company that is issuing this invoice</p>
        </div>
        
        <div>
          <%= form.label :buyer_selection, "To (Customer)", class: "block text-sm font-medium text-gray-700" %>
          <%
            buyer_options = (@buyer_options || []).map { |option|
              label = "#{option[:name]} #{option[:type] == 'contact' ? '(Contact)' : '(Company)'}"
              ["#{label}", "#{option[:type]}:#{option[:id]}"]
            }

            selected_value = if invoice[:buyer_party_id].present?
              "company:#{invoice[:buyer_party_id]}"
            elsif invoice[:buyer_company_contact_id].present?
              "contact:#{invoice[:buyer_company_contact_id]}"
            else
              nil
            end
          %>
          <%= select_tag "buyer_selection",
              options_for_select(buyer_options, selected_value),
              {
                include_blank: 'Select customer',
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                data: {
                  action: "change->invoice-form#updateBuyer",
                  "invoice-form-target": "buyerSelect"
                },
                required: true
              } %>

          <!-- Hidden fields for actual form submission -->
          <%= form.hidden_field :buyer_party_id, value: invoice[:buyer_party_id], data: { "invoice-form-target": "buyerPartyId" } %>
          <%= form.hidden_field :buyer_company_contact_id, value: invoice[:buyer_company_contact_id], data: { "invoice-form-target": "buyerContactId" } %>

          <p class="mt-1 text-xs text-gray-500">Select a company or contact for this invoice</p>
        </div>
        
        <div data-invoice-form-target="contactField" style="<%= 'display: none;' unless invoice[:buyer_party_id].present? %>">
          <%= form.label :buyer_company_contact_id, "Contact Person", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :buyer_company_contact_id,
              options_for_select(
                begin
                  if invoice[:buyer_party_id].present? && @company_contacts && @company_contacts[invoice[:buyer_party_id].to_s]
                    @company_contacts[invoice[:buyer_party_id].to_s].map { |c| [c[:full_name] || c[:name], c[:id]] }
                  else
                    []
                  end
                end,
                invoice[:buyer_company_contact_id]
              ),
              { include_blank: 'Select contact person (optional)' },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              data: { "invoice-form-target": "contactSelect" } %>
          <p class="mt-1 text-xs text-gray-500">
            Optional: Select a specific contact person for this invoice.
            <a href="#" class="text-indigo-600 hover:text-indigo-500" data-action="click->invoice-form#openContactModal">Manage contacts</a>
          </p>
        </div>
        
        <div>
          <%= form.label :issue_date, "Invoice Date", class: "block text-sm font-medium text-gray-700" %>
          <%= form.date_field :issue_date, value: invoice[:issue_date],
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              required: true %>
        </div>
        
        <div>
          <%= form.label :due_date, class: "block text-sm font-medium text-gray-700" %>
          <%= form.date_field :due_date, value: invoice[:due_date],
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Tax Context Section -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex flex-col space-y-4 mb-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0">
        <div>
          <h3 class="text-lg font-medium text-gray-900">Tax Context</h3>
          <p class="mt-1 text-sm text-gray-600">Configure tax settings and jurisdiction for this invoice</p>
        </div>
        <div class="flex items-center">
          <button type="button"
                  data-action="click->invoice-form#refreshTaxContext"
                  data-invoice-form-target="refreshTaxButton"
                  class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 w-full justify-center sm:w-auto">
            <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            Refresh Context
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        <!-- Company Establishment -->
        <div>
          <%= form.label :establishment_id, "Company Establishment", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :establishment_id,
              options_for_select(
                (@company_establishments || []).map { |est| [est[:display_name] || est[:name], est[:id]] },
                invoice[:establishment_id]
              ),
              { include_blank: 'Select establishment' },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              data: {
                action: "change->invoice-form#onEstablishmentChange",
                "invoice-form-target": "establishmentSelect"
              } %>
          <p class="mt-1 text-xs text-gray-500">Select the company location issuing this invoice</p>
          <% if @errors && @errors["establishment_id"] %>
            <% @errors["establishment_id"].each do |error| %>
              <p class="mt-1 text-sm text-red-600"><%= error %></p>
            <% end %>
          <% end %>
        </div>

        <!-- Tax Jurisdiction Display -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Tax Jurisdiction</label>
          <div class="mt-1 p-3 bg-gray-50 rounded-md border border-gray-300">
            <div data-invoice-form-target="taxJurisdiction" class="text-sm text-gray-600">
              Select an establishment to see tax jurisdiction
            </div>
          </div>
          <p class="mt-1 text-xs text-gray-500">Tax jurisdiction determined by selected establishment</p>
        </div>

        <!-- Buyer Location Override -->
        <div class="col-span-1 sm:col-span-2">
          <div class="flex items-center justify-between">
            <label class="block text-sm font-medium text-gray-700">Buyer Location Override</label>
            <button type="button"
                    data-action="click->invoice-form#toggleBuyerLocation"
                    data-invoice-form-target="buyerLocationToggle"
                    class="inline-flex items-center px-2 py-1 text-xs font-medium rounded text-indigo-600 bg-indigo-50 hover:bg-indigo-100">
              <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Override
            </button>
          </div>

          <div data-invoice-form-target="buyerLocationFields" class="hidden mt-2">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <%= form.label :buyer_country_override, "Country", class: "block text-sm font-medium text-gray-700" %>
                <%= form.select :buyer_country_override,
                    options_for_select([
                      ['Spain', 'ESP'],
                      ['France', 'FRA'],
                      ['Germany', 'DEU'],
                      ['Italy', 'ITA'],
                      ['Portugal', 'PRT'],
                      ['United Kingdom', 'GBR'],
                      ['United States', 'USA']
                    ], invoice[:buyer_country_override]),
                    { include_blank: 'Auto-detect from buyer' },
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                    data: { action: "change->invoice-form#onBuyerLocationChange" } %>
              </div>

              <div>
                <%= form.label :buyer_city_override, "City", class: "block text-sm font-medium text-gray-700" %>
                <%= form.text_field :buyer_city_override, value: invoice[:buyer_city_override],
                    class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                    placeholder: "Override buyer city",
                    data: { action: "input->invoice-form#onBuyerLocationChange" } %>
              </div>
            </div>
            <p class="mt-1 text-xs text-gray-500">Override buyer location for tax calculations (useful for cross-border transactions)</p>
          </div>
        </div>

        <!-- Tax Context Status -->
        <div class="col-span-1 sm:col-span-2">
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-sm font-medium text-gray-900">Tax Context Status</h4>
                <div data-invoice-form-target="taxContextStatus" class="mt-1 text-sm text-gray-600">
                  Ready for tax calculation
                </div>
              </div>
              <div data-invoice-form-target="taxContextIndicator" class="flex-shrink-0">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  Not calculated
                </span>
              </div>
            </div>

            <!-- Tax Context Details -->
            <div data-invoice-form-target="taxContextDetails" class="mt-4 hidden">
              <dl class="grid grid-cols-1 gap-x-4 gap-y-2 sm:grid-cols-2">
                <div>
                  <dt class="text-xs font-medium text-gray-500">Transaction Type</dt>
                  <dd class="text-sm text-gray-900" data-invoice-form-target="transactionType">-</dd>
                </div>
                <div>
                  <dt class="text-xs font-medium text-gray-500">Cross-Border</dt>
                  <dd class="text-sm text-gray-900" data-invoice-form-target="crossBorder">-</dd>
                </div>
                <div>
                  <dt class="text-xs font-medium text-gray-500">EU Transaction</dt>
                  <dd class="text-sm text-gray-900" data-invoice-form-target="euTransaction">-</dd>
                </div>
                <div>
                  <dt class="text-xs font-medium text-gray-500">Reverse Charge</dt>
                  <dd class="text-sm text-gray-900" data-invoice-form-target="reverseCharge">-</dd>
                </div>
              </dl>
            </div>

            <!-- Auto-calculate Tax Context -->
            <div class="mt-4 flex items-center justify-between">
              <div class="flex items-center">
                <%= form.check_box :auto_calculate_tax_context, checked: true,
                    class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded",
                    data: { "invoice-form-target": "autoTaxCalculate" } %>
                <%= form.label :auto_calculate_tax_context, "Auto-calculate tax context",
                    class: "ml-2 block text-sm text-gray-900" %>
              </div>
              <button type="button"
                      data-action="click->invoice-form#calculateTaxContext"
                      data-invoice-form-target="calculateTaxButton"
                      class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="-ml-0.5 mr-1.5 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V4.875c0-.621-.504-1.125-1.125-1.125h-9.75c0 1.036.84 1.875 1.875 1.875h8.25c.621 0 1.125.504 1.125 1.125zM8.25 15.75l-3-3 3-3" />
                </svg>
                Calculate
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden fields for tax context data -->
      <%= form.hidden_field :tax_context_establishment_id, data: { "invoice-form-target": "taxContextEstablishmentId" } %>
      <%= form.hidden_field :tax_context_cross_border, data: { "invoice-form-target": "taxContextCrossBorder" } %>
      <%= form.hidden_field :tax_context_eu_transaction, data: { "invoice-form-target": "taxContextEuTransaction" } %>
      <%= form.hidden_field :tax_context_reverse_charge, data: { "invoice-form-target": "taxContextReverseCharge" } %>
    </div>
  </div>

  <!-- Line Items -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">Line Items</h3>
        <button type="button" 
                data-action="click->invoice-form#addLineItem"
                data-invoice-form-target="addButton"
                class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Add Line
        </button>
      </div>
      
      <!-- Desktop Table View -->
      <div class="hidden lg:block overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Description
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Qty
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Unit Price
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Tax %
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Discount %
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Total
              </th>
              <th scope="col" class="relative px-3 py-3">
                <span class="sr-only">Actions</span>
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" data-invoice-form-target="lineItems">
            <% lines = invoice[:invoice_lines] || []
               lines = lines.values if lines.respond_to?(:values) # Handle ActionController::Parameters
               lines.each_with_index do |line, index| %>
              <!-- Product Selector Row -->
              <tr class="bg-blue-50 border-b border-blue-100">
                <td colspan="7" class="px-3 py-2">

                  <div class="product-selector-row mt-2" id="product-selector-<%= index %>"
                       data-controller="product-selector"
                       data-product-selector-search-url-value="<%= search_products_path %>"
                       data-product-selector-line-index-value="<%= index %>">
                    <div class="bg-white rounded-lg p-4 border border-blue-200">
                      <div class="flex items-center space-x-3">
                        <div class="flex-1 relative">
                          <input type="text"
                                 data-product-selector-target="search"
                                 data-action="input->product-selector#search focus->product-selector#search"
                                 class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm pl-10"
                                 placeholder="Search products by name or SKU..."
                                 autocomplete="off" />

                          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0110.607 10.607z" />
                            </svg>
                          </div>

                          <div data-product-selector-target="results"
                               class="absolute z-50 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm hidden">
                          </div>
                        </div>

                        <button type="button"
                                data-action="click->product-selector#clearSelection"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                          Clear
                        </button>
                        <button type="button"
                                data-action="click->product-selector#createLine"
                                data-product-selector-target="createLineButton"
                                disabled
                                class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-green-600 opacity-50 cursor-not-allowed">
                          <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                          </svg>
                          Create Line
                        </button>
                        <button type="button"
                                data-action="click->product-modal#open"
                                class="inline-flex items-center px-3 py-2 border border-transparent shadow-sm text-sm leading-4 font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                          <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          New Product
                        </button>
                      </div>

                      <div class="mt-2 text-xs text-gray-500 bg-gray-50 p-2 rounded">
                        💡 <strong>Tip:</strong> Search and select a product, then click "Create Line" to add it as a new invoice line. You can also enter line details manually below.
                      </div>
                    </div>
                  </div>
                </td>
              </tr>

              <!-- Line Item Data Row -->
              <tr class="line-item">
                <%= hidden_field_tag "invoice[invoice_lines][#{index}][id]", line[:id] %>
                <%= hidden_field_tag "invoice[invoice_lines][#{index}][line_number]", line[:line_number] %>
                <td class="px-3 py-2">
                  <%= text_field_tag "invoice[invoice_lines][#{index}][description]",
                      line[:description],
                      class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      placeholder: "Item description" %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][quantity]",
                      line[:quantity],
                      class: "block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][unit_price]",
                      line[:unit_price],
                      class: "block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][tax_rate]",
                      line[:tax_rate],
                      class: "block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      max: 100,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][discount_percentage]",
                      line[:discount_percentage],
                      class: "block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      max: 100,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </td>
                <td class="px-3 py-2">
                  <span class="line-total text-sm font-medium text-gray-900">€0.00</span>
                </td>
                <td class="px-3 py-2">
                  <button type="button"
                          data-action="click->invoice-form#removeLineItem"
                          class="text-red-600 hover:text-red-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                  </button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="lg:hidden space-y-4" data-invoice-form-target="mobileLineItems">
        <% lines = invoice[:invoice_lines] || []
           lines = lines.values if lines.respond_to?(:values) # Handle ActionController::Parameters
           lines.each_with_index do |line, index| %>
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 line-item-mobile" data-line-index="<%= index %>">
            <div class="flex justify-between items-start mb-3">
              <h4 class="text-sm font-medium text-gray-900">Line Item <%= index + 1 %></h4>
              <button type="button"
                      data-action="click->invoice-form#removeLineItem"
                      class="text-red-600 hover:text-red-900 p-1">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                </svg>
              </button>
            </div>

            <%= hidden_field_tag "invoice[invoice_lines][#{index}][id]", line[:id] %>
            <%= hidden_field_tag "invoice[invoice_lines][#{index}][line_number]", line[:line_number] %>

            <div class="space-y-3">
              <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Description</label>
                <%= text_field_tag "invoice[invoice_lines][#{index}][description]",
                    line[:description],
                    class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm",
                    placeholder: "Item description" %>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Quantity</label>
                  <%= number_field_tag "invoice[invoice_lines][#{index}][quantity]",
                      line[:quantity],
                      class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm",
                      step: 0.01,
                      min: 0,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Unit Price</label>
                  <%= number_field_tag "invoice[invoice_lines][#{index}][unit_price]",
                      line[:unit_price],
                      class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm",
                      step: 0.01,
                      min: 0,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Tax %</label>
                  <%= number_field_tag "invoice[invoice_lines][#{index}][tax_rate]",
                      line[:tax_rate],
                      class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm",
                      step: 0.01,
                      min: 0,
                      max: 100,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </div>

                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Discount %</label>
                  <%= number_field_tag "invoice[invoice_lines][#{index}][discount_percentage]",
                      line[:discount_percentage],
                      class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm",
                      step: 0.01,
                      min: 0,
                      max: 100,
                      data: {
                        action: "input->invoice-form#calculateLineTotal"
                      } %>
                </div>
              </div>

              <div class="pt-2 border-t border-gray-200">
                <div class="flex justify-between items-center">
                  <span class="text-sm font-medium text-gray-700">Line Total:</span>
                  <span class="line-total text-sm font-semibold text-gray-900">€0.00</span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Line Item Template -->
      <template data-invoice-form-target="lineItemTemplate">
        <tr class="line-item">
          <td class="px-3 py-2">
            <input type="text" name="invoice[invoice_lines][NEW_RECORD][description]"
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   placeholder="Item description">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][quantity]"
                   value="1"
                   class="block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][unit_price]"
                   value="0"
                   class="block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][tax_rate]"
                   value="21"
                   class="block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0" max="100"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][discount_percentage]"
                   value="0"
                   class="block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0" max="100"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <span class="line-total text-sm font-medium text-gray-900">€0.00</span>
          </td>
          <td class="px-3 py-2">
            <button type="button"
                    data-action="click->invoice-form#removeLineItem"
                    class="text-red-600 hover:text-red-900">
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
              </svg>
            </button>
          </td>
        </tr>
      </template>

      <!-- Global Financial Adjustments -->
      <div class="mt-6 border-t pt-4">
        <h4 class="text-md font-medium text-gray-900 mb-4">Global Financial Adjustments</h4>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <!-- General Discounts -->
          <div>
            <%= form.label :total_general_discounts, "General Discounts", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_general_discounts,
                value: invoice[:total_general_discounts] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Invoice-wide discount amount</p>
          </div>

          <!-- General Surcharges -->
          <div>
            <%= form.label :total_general_surcharges, "General Surcharges", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_general_surcharges,
                value: invoice[:total_general_surcharges] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Invoice-wide surcharge amount</p>
          </div>

          <!-- Financial Expenses -->
          <div>
            <%= form.label :total_financial_expenses, "Financial Expenses", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_financial_expenses,
                value: invoice[:total_financial_expenses] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Interest, bank charges, etc.</p>
          </div>

          <!-- Reimbursable Expenses -->
          <div>
            <%= form.label :total_reimbursable_expenses, "Reimbursable Expenses", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_reimbursable_expenses,
                value: invoice[:total_reimbursable_expenses] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Travel, materials, etc.</p>
          </div>

          <!-- Withholding Amount -->
          <div>
            <%= form.label :withholding_amount, "Withholding Amount", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :withholding_amount,
                value: invoice[:withholding_amount] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Tax withholding amount</p>
          </div>

          <!-- Payment in Kind Amount -->
          <div>
            <%= form.label :payment_in_kind_amount, "Payment in Kind", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :payment_in_kind_amount,
                value: invoice[:payment_in_kind_amount] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Non-monetary payment amount</p>
          </div>
        </div>
      </div>

      <!-- Totals -->
      <div class="mt-6 border-t pt-4">
        <div class="flex justify-end">
          <dl class="space-y-2 text-sm">
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Subtotal:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="subtotal">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">General Discounts:</dt>
              <dd class="font-medium text-red-600" data-invoice-form-target="generalDiscounts">-€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">General Surcharges:</dt>
              <dd class="font-medium text-green-600" data-invoice-form-target="generalSurcharges">+€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Financial Expenses:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="financialExpenses">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Reimbursable Expenses:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="reimbursableExpenses">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Gross Before Taxes:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="grossBeforeTaxes">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Tax:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="tax">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Withholding:</dt>
              <dd class="font-medium text-red-600" data-invoice-form-target="withholding">-€0.00</dd>
            </div>
            <div class="flex justify-between border-t pt-2">
              <dt class="text-base font-medium text-gray-900">Total:</dt>
              <dd class="text-base font-medium text-gray-900" data-invoice-form-target="total">€0.00</dd>
            </div>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Information -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Additional Information</h3>
      
      <div class="space-y-4">
        <div>
          <%= form.label :notes, "Customer Notes", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :notes, value: invoice[:notes],
              rows: 3,
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              placeholder: "Notes visible to the customer" %>
        </div>
        
        <div>
          <%= form.label :internal_notes, class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :internal_notes, value: invoice[:internal_notes],
              rows: 3,
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              placeholder: "Internal notes (not visible to customer)" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Cross-Border Transaction Validation -->
  <div class="bg-white shadow rounded-lg" data-controller="cross-border-validator">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex flex-col space-y-4 mb-4 sm:flex-row sm:items-center sm:justify-between sm:space-y-0">
        <div>
          <h3 class="text-lg font-medium text-gray-900">Cross-Border Validation</h3>
          <p class="mt-1 text-sm text-gray-600">Validate tax compliance for multi-jurisdiction transactions</p>
        </div>
        <div class="flex items-center">
          <button type="button"
                  data-action="click->cross-border-validator#validateTransaction"
                  data-cross-border-validator-target="validationButton"
                  class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 w-full justify-center sm:w-auto">
            Validate Transaction
          </button>
        </div>
      </div>

      <!-- Validation Results (initially hidden) -->
      <div data-cross-border-validator-target="validationResults" class="hidden">
        <!-- Validation Status -->
        <div class="mb-4">
          <div data-cross-border-validator-target="validationStatus" class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium border bg-gray-100 text-gray-800 border-gray-200">
            <span class="mr-2">ℹ️</span>
            Ready to validate
          </div>
        </div>

        <!-- Validation Details Grid -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
          <!-- Warnings -->
          <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
            <h4 class="text-sm font-medium text-yellow-800 mb-3">
              <span class="mr-2">⚠️</span>
              Warnings & Considerations
            </h4>
            <ul data-cross-border-validator-target="warningsList" class="space-y-2 text-sm">
              <li class="text-gray-500 italic">No validation performed yet</li>
            </ul>
          </div>

          <!-- Recommendations -->
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <h4 class="text-sm font-medium text-blue-800 mb-3">
              <span class="mr-2">💡</span>
              Recommendations
            </h4>
            <ul data-cross-border-validator-target="recommendationsList" class="space-y-2 text-sm">
              <li class="text-gray-500 italic">No validation performed yet</li>
            </ul>
          </div>

          <!-- Required Documents -->
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <h4 class="text-sm font-medium text-gray-800 mb-3">
              <span class="mr-2">📄</span>
              Required Documents
            </h4>
            <ul data-cross-border-validator-target="documentsList" class="space-y-2 text-sm">
              <li class="text-gray-500 italic">No validation performed yet</li>
            </ul>
          </div>
        </div>

        <!-- Compliance Summary -->
        <div class="mt-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
          <h4 class="text-sm font-medium text-gray-800 mb-2">
            <span class="mr-2">📋</span>
            Compliance Summary
          </h4>
          <div class="text-sm text-gray-600">
            Cross-border tax validation helps ensure compliance with international tax regulations.
            This includes EU intra-community transactions, export regulations, digital services rules,
            and VAT registration requirements.
          </div>
        </div>

        <!-- Auto-validation Toggle -->
        <div class="mt-4 flex items-center justify-between p-3 bg-indigo-50 rounded-lg border border-indigo-200">
          <div class="flex items-center">
            <%= form.check_box :auto_validate_cross_border, checked: false,
                class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" %>
            <%= form.label :auto_validate_cross_border, "Auto-validate on changes",
                class: "ml-2 block text-sm text-indigo-900 font-medium" %>
          </div>
          <div class="text-xs text-indigo-700">
            Automatically validate when invoice details change
          </div>
        </div>
      </div>

      <!-- Validation Hint (shown when no validation performed) -->
      <div class="text-center py-8 text-gray-500" data-cross-border-validator-target="validationHint">
        <div class="mb-3">
          <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <p class="text-sm font-medium mb-1">Cross-Border Tax Validation</p>
        <p class="text-xs">
          Validate tax compliance requirements for international transactions.<br>
          Click "Validate Transaction" to check regulations and requirements.
        </p>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-col space-y-3 sm:flex-row sm:justify-end sm:space-y-0 sm:space-x-3">
    <%= link_to "Cancel", invoices_path,
        class: "w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-center" %>
    <%= form.submit "Save as Draft", name: "save_draft",
        class: "w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    <%= form.submit invoice.is_a?(Hash) && !invoice[:id] ? "Create Invoice" : "Update Invoice",
        class: "w-full sm:w-auto px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
  </div>
<% end %>

<!-- Include Product Creation Modal -->
<%= render 'shared/product_creation_modal' %>

