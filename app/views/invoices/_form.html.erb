<%= form_with url: invoice.is_a?(Hash) && invoice[:id].present? ? invoice_path(invoice[:id]) : invoices_path, 
              method: invoice.is_a?(Hash) && invoice[:id].present? ? :patch : :post,
              scope: :invoice,
              local: true, 
              data: { controller: "invoice-form" },
              class: "space-y-6" do |form| %>
  
  <% if @errors.present? %>
    <div class="rounded-md bg-red-50 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            There were errors with your submission
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc pl-5 space-y-1">
              <% @errors.each do |field, messages| %>
                <% Array(messages).each do |message| %>
                  <li><%= field.to_s.humanize %> <%= message %></li>
                <% end %>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Invoice Header -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Invoice Information</h3>
      
      <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
        <div>
          <%= form.label :invoice_series_id, "Invoice Series", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :invoice_series_id,
              options_for_select(
                (@invoice_series || []).map { |series| ["#{series[:series_code]} - #{series[:series_name]}", series[:id].to_s] },
                invoice[:invoice_series_id]&.to_s
              ),
              { include_blank: 'Select invoice series' },
              class: field_class("invoice_series_id", "mt-1 block w-full rounded-md shadow-sm focus:ring-indigo-500 sm:text-sm", @errors),
              data: {
                action: "change->invoice-form#onSeriesChange",
                "invoice-form-target": "seriesSelect"
              },
              required: true %>
          <% if @errors && @errors["invoice_series_id"] %>
            <% @errors["invoice_series_id"].each do |error| %>
              <p class="mt-1 text-sm text-red-600"><%= error %></p>
            <% end %>
          <% end %>
        </div>
        
        <div>
          <%= form.label :invoice_number, "Invoice Number", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_field :invoice_number, value: invoice[:invoice_number],
              class: field_class("invoice_number", "mt-1 block w-full rounded-md bg-gray-50 shadow-sm sm:text-sm", @errors),
              placeholder: "Will be auto-generated",
              readonly: true,
              data: { "invoice-form-target": "invoiceNumber" } %>
          <p class="mt-1 text-xs text-gray-500">Number will be automatically assigned when you select a series</p>
          <% if @errors && @errors["invoice_number"] %>
            <% @errors["invoice_number"].each do |error| %>
              <p class="mt-1 text-sm text-red-600"><%= error %></p>
            <% end %>
          <% end %>
        </div>
        
        <div>
          <%= form.label :invoice_type, class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :invoice_type,
              options_for_select([
                ['Invoice', 'invoice'],
                ['Credit Note', 'credit_note'],
                ['Debit Note', 'debit_note'],
                ['Proforma', 'proforma']
              ], invoice[:invoice_type]),
              {},
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              data: {
                action: "change->invoice-form#onInvoiceTypeChange",
                "invoice-form-target": "invoiceTypeSelect"
              } %>
        </div>
        
        <div>
          <%= form.label :status, class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :status,
              options_for_select([
                ['Draft', 'draft'],
                ['Pending', 'pending'],
                ['Sent', 'sent'],
                ['Paid', 'paid'],
                ['Cancelled', 'cancelled']
              ], invoice[:status]),
              {},
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>

        <div>
          <%= form.label :workflow_definition_id, "Workflow", class: "block text-sm font-medium text-gray-700" %>
          <%
            # Find Simple Invoice Workflow and set as default
            simple_workflow = (@workflows || []).find { |w|
              (w[:name] || w['name']) == 'Simple Invoice Workflow' ||
              (w[:code] || w['code']) == 'simple_invoice_workflow'
            }
            default_workflow_id = simple_workflow ? (simple_workflow[:id] || simple_workflow['id']).to_s : nil
            selected_workflow = (invoice[:workflow_definition_id] || invoice['workflow_definition_id']).to_s.presence || default_workflow_id
          %>
          <%= form.select :workflow_definition_id,
              options_for_select(
                (@workflows || []).map { |workflow| [workflow[:name] || workflow['name'], (workflow[:id] || workflow['id']).to_s] },
                selected_workflow
              ),
              { include_blank: 'Select workflow' },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              required: true %>
          <p class="mt-1 text-xs text-gray-500">Choose the approval workflow for this invoice</p>
        </div>
        
        <div>
          <%= form.label :seller_party_id, "From (Seller)", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :seller_party_id,
              options_for_select(
                (@seller_companies || @companies || []).map { |c| [c[:name], c[:id]] },
                invoice[:seller_party_id] || current_company_id
              ),
              { include_blank: 'Select seller company' },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              required: true %>
          <p class="mt-1 text-xs text-gray-500">Select your company that is issuing this invoice</p>
        </div>
        
        <div>
          <%= form.label :buyer_selection, "To (Customer)", class: "block text-sm font-medium text-gray-700" %>
          <%
            buyer_options = (@buyer_options || []).map { |option|
              label = "#{option[:name]} #{option[:type] == 'contact' ? '(Contact)' : '(Company)'}"
              ["#{label}", "#{option[:type]}:#{option[:id]}"]
            }

            selected_value = if invoice[:buyer_party_id].present?
              "company:#{invoice[:buyer_party_id]}"
            elsif invoice[:buyer_company_contact_id].present?
              "contact:#{invoice[:buyer_company_contact_id]}"
            else
              nil
            end
          %>
          <%= select_tag "buyer_selection",
              options_for_select(buyer_options, selected_value),
              {
                include_blank: 'Select customer',
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                data: {
                  action: "change->invoice-form#updateBuyer",
                  "invoice-form-target": "buyerSelect"
                },
                required: true
              } %>

          <!-- Hidden fields for actual form submission -->
          <%= form.hidden_field :buyer_party_id, value: invoice[:buyer_party_id], data: { "invoice-form-target": "buyerPartyId" } %>
          <%= form.hidden_field :buyer_company_contact_id, value: invoice[:buyer_company_contact_id], data: { "invoice-form-target": "buyerContactId" } %>

          <p class="mt-1 text-xs text-gray-500">Select a company or contact for this invoice</p>
        </div>
        
        <div data-invoice-form-target="contactField" style="<%= 'display: none;' unless invoice[:buyer_party_id].present? %>">
          <%= form.label :buyer_company_contact_id, "Contact Person", class: "block text-sm font-medium text-gray-700" %>
          <%= form.select :buyer_company_contact_id,
              options_for_select(
                begin
                  if invoice[:buyer_party_id].present? && @company_contacts && @company_contacts[invoice[:buyer_party_id].to_s]
                    @company_contacts[invoice[:buyer_party_id].to_s].map { |c| [c[:full_name] || c[:name], c[:id]] }
                  else
                    []
                  end
                end,
                invoice[:buyer_company_contact_id]
              ),
              { include_blank: 'Select contact person (optional)' },
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              data: { "invoice-form-target": "contactSelect" } %>
          <p class="mt-1 text-xs text-gray-500">
            Optional: Select a specific contact person for this invoice.
            <a href="#" class="text-indigo-600 hover:text-indigo-500" data-action="click->invoice-form#openContactModal">Manage contacts</a>
          </p>
        </div>
        
        <div>
          <%= form.label :issue_date, "Invoice Date", class: "block text-sm font-medium text-gray-700" %>
          <%= form.date_field :issue_date, value: invoice[:issue_date],
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              required: true %>
        </div>
        
        <div>
          <%= form.label :due_date, class: "block text-sm font-medium text-gray-700" %>
          <%= form.date_field :due_date, value: invoice[:due_date],
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Line Items -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">Line Items</h3>
        <button type="button" 
                data-action="click->invoice-form#addLineItem"
                data-invoice-form-target="addButton"
                class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Add Line
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead>
            <tr>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Description
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Qty
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Unit Price
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Tax %
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Discount %
              </th>
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Total
              </th>
              <th scope="col" class="relative px-3 py-3">
                <span class="sr-only">Actions</span>
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" data-invoice-form-target="lineItems">
            <% lines = invoice[:invoice_lines] || []
               lines = lines.values if lines.respond_to?(:values) # Handle ActionController::Parameters
               lines.each_with_index do |line, index| %>
              <tr class="line-item">
                <%= hidden_field_tag "invoice[invoice_lines][#{index}][id]", line[:id] %>
                <%= hidden_field_tag "invoice[invoice_lines][#{index}][line_number]", line[:line_number] %>
                <td class="px-3 py-2">
                  <%= text_field_tag "invoice[invoice_lines][#{index}][description]",
                      line[:description],
                      class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      placeholder: "Item description" %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][quantity]",
                      line[:quantity],
                      class: "block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      data: { action: "input->invoice-form#calculateLineTotal" } %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][unit_price]",
                      line[:unit_price],
                      class: "block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      data: { action: "input->invoice-form#calculateLineTotal" } %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][tax_rate]",
                      line[:tax_rate],
                      class: "block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      max: 100,
                      data: { action: "input->invoice-form#calculateLineTotal" } %>
                </td>
                <td class="px-3 py-2">
                  <%= number_field_tag "invoice[invoice_lines][#{index}][discount_percentage]",
                      line[:discount_percentage],
                      class: "block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                      step: 0.01,
                      min: 0,
                      max: 100,
                      data: { action: "input->invoice-form#calculateLineTotal" } %>
                </td>
                <td class="px-3 py-2">
                  <span class="line-total text-sm font-medium text-gray-900">€0.00</span>
                </td>
                <td class="px-3 py-2">
                  <button type="button"
                          data-action="click->invoice-form#removeLineItem"
                          class="text-red-600 hover:text-red-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                  </button>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      
      <!-- Line Item Template -->
      <template data-invoice-form-target="lineItemTemplate">
        <tr class="line-item">
          <td class="px-3 py-2">
            <input type="text" name="invoice[invoice_lines][NEW_RECORD][description]"
                   class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   placeholder="Item description">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][quantity]"
                   value="1"
                   class="block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][unit_price]"
                   value="0"
                   class="block w-24 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][tax_rate]"
                   value="21"
                   class="block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0" max="100"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <input type="number" name="invoice[invoice_lines][NEW_RECORD][discount_percentage]"
                   value="0"
                   class="block w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                   step="0.01" min="0" max="100"
                   data-action="input->invoice-form#calculateLineTotal">
          </td>
          <td class="px-3 py-2">
            <span class="line-total text-sm font-medium text-gray-900">€0.00</span>
          </td>
          <td class="px-3 py-2">
            <button type="button"
                    data-action="click->invoice-form#removeLineItem"
                    class="text-red-600 hover:text-red-900">
              <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
              </svg>
            </button>
          </td>
        </tr>
      </template>

      <!-- Global Financial Adjustments -->
      <div class="mt-6 border-t pt-4">
        <h4 class="text-md font-medium text-gray-900 mb-4">Global Financial Adjustments</h4>
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <!-- General Discounts -->
          <div>
            <%= form.label :total_general_discounts, "General Discounts", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_general_discounts,
                value: invoice[:total_general_discounts] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Invoice-wide discount amount</p>
          </div>

          <!-- General Surcharges -->
          <div>
            <%= form.label :total_general_surcharges, "General Surcharges", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_general_surcharges,
                value: invoice[:total_general_surcharges] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Invoice-wide surcharge amount</p>
          </div>

          <!-- Financial Expenses -->
          <div>
            <%= form.label :total_financial_expenses, "Financial Expenses", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_financial_expenses,
                value: invoice[:total_financial_expenses] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Interest, bank charges, etc.</p>
          </div>

          <!-- Reimbursable Expenses -->
          <div>
            <%= form.label :total_reimbursable_expenses, "Reimbursable Expenses", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :total_reimbursable_expenses,
                value: invoice[:total_reimbursable_expenses] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Travel, materials, etc.</p>
          </div>

          <!-- Withholding Amount -->
          <div>
            <%= form.label :withholding_amount, "Withholding Amount", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :withholding_amount,
                value: invoice[:withholding_amount] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Tax withholding amount</p>
          </div>

          <!-- Payment in Kind Amount -->
          <div>
            <%= form.label :payment_in_kind_amount, "Payment in Kind", class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :payment_in_kind_amount,
                value: invoice[:payment_in_kind_amount] || 0,
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                step: 0.01,
                min: 0,
                placeholder: "0.00",
                data: { action: "input->invoice-form#calculateTotals" } %>
            <p class="mt-1 text-xs text-gray-500">Non-monetary payment amount</p>
          </div>
        </div>
      </div>

      <!-- Totals -->
      <div class="mt-6 border-t pt-4">
        <div class="flex justify-end">
          <dl class="space-y-2 text-sm">
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Subtotal:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="subtotal">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">General Discounts:</dt>
              <dd class="font-medium text-red-600" data-invoice-form-target="generalDiscounts">-€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">General Surcharges:</dt>
              <dd class="font-medium text-green-600" data-invoice-form-target="generalSurcharges">+€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Financial Expenses:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="financialExpenses">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Reimbursable Expenses:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="reimbursableExpenses">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Gross Before Taxes:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="grossBeforeTaxes">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Tax:</dt>
              <dd class="font-medium text-gray-900" data-invoice-form-target="tax">€0.00</dd>
            </div>
            <div class="flex justify-between">
              <dt class="font-medium text-gray-500">Withholding:</dt>
              <dd class="font-medium text-red-600" data-invoice-form-target="withholding">-€0.00</dd>
            </div>
            <div class="flex justify-between border-t pt-2">
              <dt class="text-base font-medium text-gray-900">Total:</dt>
              <dd class="text-base font-medium text-gray-900" data-invoice-form-target="total">€0.00</dd>
            </div>
          </dl>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Information -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Additional Information</h3>
      
      <div class="space-y-4">
        <div>
          <%= form.label :notes, "Customer Notes", class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :notes, value: invoice[:notes],
              rows: 3,
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              placeholder: "Notes visible to the customer" %>
        </div>
        
        <div>
          <%= form.label :internal_notes, class: "block text-sm font-medium text-gray-700" %>
          <%= form.text_area :internal_notes, value: invoice[:internal_notes],
              rows: 3,
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
              placeholder: "Internal notes (not visible to customer)" %>
        </div>
      </div>
    </div>
  </div>

  <div class="flex justify-end space-x-3">
    <%= link_to "Cancel", invoices_path, 
        class: "px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    <%= form.submit "Save as Draft", name: "save_draft",
        class: "px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    <%= form.submit invoice.is_a?(Hash) && !invoice[:id] ? "Create Invoice" : "Update Invoice", 
        class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
  </div>
<% end %>