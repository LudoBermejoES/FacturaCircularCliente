<% breadcrumb ["Invoices", invoices_path], @invoice[:invoice_number] %>

<div class="space-y-6">
  <!-- Header -->
  <div class="sm:flex sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Invoice <%= @invoice[:invoice_number] %></h1>
      <div class="mt-2 flex items-center space-x-3">
        <span id="invoice_status" class="<%= status_badge_class(@invoice[:status]) %>">
          <%= @invoice[:status]&.humanize %>
        </span>
        <span class="text-sm text-gray-500">
          <%= @invoice[:invoice_type]&.humanize %>
        </span>
        <% if @invoice[:is_frozen] %>
          <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
            Frozen
          </span>
        <% end %>
      </div>
    </div>
    
    <div class="mt-4 sm:mt-0 flex flex-wrap gap-2">
      <% if @invoice[:status] == 'draft' && !@invoice[:is_frozen] %>
        <%= link_to edit_invoice_path(@invoice[:id]), 
            class: "inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
          <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
          </svg>
          Edit
        <% end %>
      <% end %>
      
      <%= link_to pdf_invoice_path(@invoice[:id]), 
          class: "inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
        <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
        </svg>
        Download PDF
      <% end %>
      
      <%= link_to facturae_invoice_path(@invoice[:id]), 
          class: "inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
        <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75 22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3-4.5 16.5" />
        </svg>
        Facturae XML
      <% end %>
      
      <button type="button" 
              onclick="document.getElementById('email-modal').classList.remove('hidden')"
              class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
        <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
        </svg>
        Send Email
      </button>
      
      <% if !@invoice[:is_frozen] && @invoice[:status] != 'cancelled' %>
        <%= button_to freeze_invoice_path(@invoice[:id]), method: :post,
            class: "inline-flex items-center px-3 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700" do %>
          <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
          </svg>
          Freeze Invoice
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Invoice Details -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6">
          <h3 class="text-lg font-medium text-gray-900">Invoice Details</h3>
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
          <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            <div>
              <dt class="text-sm font-medium text-gray-500">Invoice Number</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @invoice[:invoice_number] %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Type</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @invoice[:invoice_type]&.humanize %></dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Invoice Date</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @invoice[:date] ? Date.parse(@invoice[:date]).strftime("%B %d, %Y") : '-' %>
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Due Date</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @invoice[:due_date] ? Date.parse(@invoice[:due_date]).strftime("%B %d, %Y") : '-' %>
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Payment Terms</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @invoice[:payment_terms] ? "#{@invoice[:payment_terms]} days" : '-' %>
              </dd>
            </div>
            <div>
              <dt class="text-sm font-medium text-gray-500">Payment Method</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @invoice[:payment_method]&.humanize || '-' %>
              </dd>
            </div>
          </dl>
        </div>
      </div>

      <!-- Customer Information -->
      <% if @company %>
        <div class="bg-white shadow rounded-lg">
          <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg font-medium text-gray-900">Customer Information</h3>
          </div>
          <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
            <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
              <div>
                <dt class="text-sm font-medium text-gray-500">Company</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= link_to @company[:name], company_path(@company[:id]), class: "text-indigo-600 hover:text-indigo-500" %>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Tax ID</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @company[:tax_id] || '-' %></dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Email</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <% if @company[:email] %>
                    <a href="mailto:<%= @company[:email] %>" class="text-indigo-600 hover:text-indigo-500">
                      <%= @company[:email] %>
                    </a>
                  <% else %>
                    -
                  <% end %>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Phone</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @company[:phone] || '-' %></dd>
              </div>
            </dl>
          </div>
        </div>
      <% end %>

      <!-- Line Items -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6">
          <h3 class="text-lg font-medium text-gray-900">Line Items</h3>
        </div>
        <div class="border-t border-gray-200">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Description
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Qty
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Unit Price
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Tax
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Discount
                </th>
                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Total
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% (@invoice[:invoice_lines] || []).each do |line| %>
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <%= line[:description] %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <%= line[:quantity] %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    €<%= number_with_delimiter(line[:unit_price] || 0, delimiter: ',') %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <%= line[:tax_rate] %>%
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <%= line[:discount_percentage] || 0 %>%
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">
                    €<%= number_with_delimiter(line[:total] || 0, delimiter: ',') %>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr>
                <th colspan="5" class="px-6 py-3 text-right text-sm font-medium text-gray-500">Subtotal:</th>
                <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900 text-right">
                  €<%= number_with_delimiter(@invoice[:subtotal] || 0, delimiter: ',') %>
                </td>
              </tr>
              <tr>
                <th colspan="5" class="px-6 py-3 text-right text-sm font-medium text-gray-500">Tax:</th>
                <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900 text-right">
                  €<%= number_with_delimiter(@invoice[:total_tax] || 0, delimiter: ',') %>
                </td>
              </tr>
              <tr class="bg-gray-50">
                <th colspan="5" class="px-6 py-3 text-right text-base font-medium text-gray-900">Total:</th>
                <td class="px-6 py-3 whitespace-nowrap text-base font-medium text-gray-900 text-right">
                  €<%= number_with_delimiter(@invoice[:total] || 0, delimiter: ',') %>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Notes -->
      <% if @invoice[:notes].present? || @invoice[:internal_notes].present? %>
        <div class="bg-white shadow rounded-lg">
          <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg font-medium text-gray-900">Notes</h3>
          </div>
          <div class="border-t border-gray-200 px-4 py-5 sm:px-6 space-y-4">
            <% if @invoice[:notes].present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Customer Notes</dt>
                <dd class="mt-1 text-sm text-gray-900"><%= @invoice[:notes] %></dd>
              </div>
            <% end %>
            <% if @invoice[:internal_notes].present? %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Internal Notes</dt>
                <dd class="mt-1 text-sm text-gray-900 italic"><%= @invoice[:internal_notes] %></dd>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Status Actions -->
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6">
          <h3 class="text-lg font-medium text-gray-900">Actions</h3>
        </div>
        <div class="border-t border-gray-200 px-4 py-5 sm:px-6">
          <div class="space-y-3">
            <%= link_to invoice_workflow_path(@invoice[:id]), 
                class: "w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700" do %>
              <svg class="-ml-0.5 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Manage Workflow
            <% end %>
            
            <button type="button" class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
              Duplicate Invoice
            </button>
          </div>
        </div>
      </div>

      <!-- Workflow History -->
      <% if @workflow_history && @workflow_history.any? %>
        <div class="bg-white shadow rounded-lg">
          <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg font-medium text-gray-900">History</h3>
          </div>
          <div class="border-t border-gray-200">
            <ul class="divide-y divide-gray-200">
              <% @workflow_history.each do |event| %>
                <li class="px-4 py-3">
                  <div class="flex space-x-3">
                    <div class="flex-1 space-y-1">
                      <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium"><%= event[:action]&.humanize %></h3>
                        <p class="text-sm text-gray-500">
                          <%= event[:created_at] ? Time.parse(event[:created_at]).strftime("%b %d, %H:%M") : '-' %>
                        </p>
                      </div>
                      <p class="text-sm text-gray-500">
                        <%= event[:user_name] || 'System' %>
                      </p>
                      <% if event[:comment].present? %>
                        <p class="text-sm text-gray-600"><%= event[:comment] %></p>
                      <% end %>
                    </div>
                  </div>
                </li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Email Modal -->
<div id="email-modal" class="hidden fixed z-10 inset-0 overflow-y-auto">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
      <div class="absolute inset-0 bg-gray-500 bg-opacity-75"></div>
    </div>
    
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    
    <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
      <%= form_with url: send_email_invoice_path(@invoice[:id]), method: :post, local: true do |f| %>
        <div>
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            Send Invoice by Email
          </h3>
          <div class="mt-4">
            <%= f.label :recipient_email, "Recipient Email", class: "block text-sm font-medium text-gray-700" %>
            <%= f.email_field :recipient_email, 
                value: (@company ? @company[:email] : ""),
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm",
                required: true %>
          </div>
        </div>
        <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
          <%= f.submit "Send Email", 
              class: "w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm" %>
          <button type="button" 
                  onclick="document.getElementById('email-modal').classList.add('hidden')"
                  class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
            Cancel
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>